language: node_js
dist: trusty
sudo: true
node_js:
- 12.13.0
addons:
  apt:
    packages:
    - python-pip
notifications:
  email: false
  slack:
    rooms:
    - gapminder:siB4Z9ymsYR6qHnRPpgUoB2Q#vizabi-spam
    on_success: change
    on_failure: always
cache:
  directories:
  - node_modules
before_install:
- ssh-keyscan -H $TOOLSPAGE_HOST 2>&1 | tee -a $HOME/.ssh/known_hosts
- openssl aes-256-cbc -K $encrypted_6f3bd6d63370_key -iv $encrypted_6f3bd6d63370_iv -in deploy_rsa.enc -out /tmp/deploy_rsa -d
- eval "$(ssh-agent -s)"
- chmod 600 /tmp/deploy_rsa
- ssh-add /tmp/deploy_rsa
- sudo pip install s3cmd
install:
- npm install --ignore-scripts
before_script:
- export DISPLAY=:99.0
- sh -e /etc/init.d/xvfb start
script:
- tool-bump
- npm run build
deploy:
- provider: script
  skip_cleanup: true
  script: tool-deploy-s3
  on:
    branch: switch_to_rollup
- provider: npm
  skip_cleanup: true
  email: konzeptmeister@gmail.com
  api_key:
    secure: gAq2fBgxT9xpcCgPyWpebBZiYuAUUVB1rIaQSj5b4FPwKN0+Kh4pd9zgSUxWVUTDzEWG1jNgenS1hXhUiGetVQOJoG/roeu6gXy/AhDdhd9hmQhrfraYnjovrdeFlm/ypOlAi+rfGVuphyCYef9U0mfSnTUGqsdjPlin1GK3mkwXL7mNIM3f+hcA8UbMLMSgYZwGpfxojV/AHZOk4j2C44mA30NivGbwZvpXV0DyBPCjFX4QeWn+VUn4mXMtIvBcqizC65a4EZjU8S2md5J/bInN1YRB5yeZxbfPl9ekB5ig3eBDQPYw2C/wQ8oMNJ3EtH+KJLwNpZye0sUxBHC3Raz9AusT+0I00xUccz/A5RW5bAC3PuZUtthN23zpfnGdFcr1+KbomJMy2m2SRq34VjktePxE4GQADh2bc6wqiQerX919VMQk/Gbb0KTJpVtvWMAYtWAvpaOC+T+g+1YJS84vVdxu4Of+Ir2iNuMMnH310TC1U+4ef0n/FFM6enChtISVU+JQPIyiQtk+qJ9LzP9D/WTaLzL2cZxgAi2PIb6t9NG5YVVDF9eBbTtgQF5zRWo8kRLpYuOYo+xOvHvRWkWJ0MKyW5+uczBfKhxVd3H5sgUPQZVonYa6csgih9TipZOztgIL877W27PCORQip/9x+ueL4WWpx3i8Kzh8R7c=
  on:
    branch: switch_to_rollup
    condition: "-e /tmp/deployment.flag"
- provider: script
  skip_cleanup: true
  script: ssh $TOOLSPAGE_USER@$TOOLSPAGE_HOST 'sh /home/root/redeploy.sh "$TRAVIS_REPO_SLUG"'
  on:
    branch: switch_to_rollup
